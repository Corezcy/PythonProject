

# 概述

> 本文档是对广州期货交易所（以下简称广期所）新一代交易系统的系统非功能需求等设计任务的需求分析和方案设计描述，包括容量指标、容错容灾、运维监控、安全需求、测试支持等几个方面。

# 项目背景

> 为了服务我所创新品种上市、满足监管改革要求、积极回应市场诉求，由运维部门牵头，联合安全、测试、主机、网络等部门共计收到81项非功能需求，其中有74项涉及新交易系统功能。分析非功能需求后，在各POC迭代版本的基础上，按照"存则不增，缺则慎加，避免冗余"的原则，共增加29项设计任务，涉及高性能日志、初始化文件重构\...等功能。新一代交易系统为支持未来我所的系统的可运维性和可观测性，全面落实各项设计任务。

# 项目目标

定义新一代核心交易系统的非功能需求，对项目实现技术功能做全面描述，为新一代系统建设提供支持。明确新一代交易系统的容量、性能、运维管理需求、行情系统需求、API接口和接入协议。整体目标框架如下图所示：

> ![捕获3](media/image1.png){width="6.013888888888889in" height="2.754166666666667in"}

# 涉及部门及第三方

无

[]{#_Toc691695262 .anchor}

# 第二章 容量优化目标需求描述

# **业务功能**需求列表

------ ---------------- ------------------------ --------------------------------------------------------------------------------------------------------------
  序号   模块             业务功能                 功能描述

  1      交易系统         初始化文件加载           系统通过表粒度拆分初始化文件、模块订阅表设计及启动流程优化，实现容量指标要求下的高效初始化文件加载

  2      交易系统         初始化文件分发模块       系统通过scp协议替代ftp进行文件传输，支持文件校验、多线程并发传输及断点续传功能，实现高效可靠的初始化文件分发

  3      交易前置、资金   会员连接管理与资金分组   交易前置与资金实施会员连接负载均衡，合理分配委托量至各工作线程
------ ---------------- ------------------------ --------------------------------------------------------------------------------------------------------------

# **业务功能需求描述**

\[概括性描述\]

\[按业务类别详细描述业务功能需求, 根据项目涉及业务范围进行裁剪\]

## 容量分析

1.  []{#_Toc358897815 .anchor}**交易链路模块容量分析**

> 由于新一代交易系统在系统容量设计上大幅提升，也带来内存表数据量级的增长。在交易系统关键链路实时风控和撮合上，与委托量、客户数、合约数等相关的主要内存表及对应内存占用如下：

------------------------- ---------------
            指标             设计测试容量
    
           日委托            **100000000**
    
          客户总数            **600000**
    
      最大合约数(活跃）        **1500**
    
            会员                **200**
    
           席位数              **10000**
------------------------- ---------------

> 资金模块关键内存表容量统计：

------------------------ ----------------------- ----------------------------- ----------------------- ------------ ----------------------
         **内存表**         **表记录大小(bytes)**   **会员/客户/席位/其它规模**   **最大合约数(活跃）**   **日委托**   **最大内存占用(GB)**
    
           委托表                    336                                                                  100000000        31.29243851
    
       客户交易持仓表                344                      600000                      1500                             288.3374691
    
       交易持仓明细表                224                      600000                      1500                              187.754631
    
           成交表                    368                                                                   10000000        6.854534149

   场上客户优惠组合持仓表            164                      600000                      1500                              137.463212

           委托表                    96                                                                   100000000        8.940696716
    
       客户限仓使用表                84                       600000                      1500                             70.40798664
    
     场上客户套利持仓表              156                      600000                       150                             13.07576895
    
         持仓明细表                  56                       600000                      1500                             46.93865776
    
       优惠组合持仓表                48                       600000                      1500                             40.23313522
------------------------ ----------------------- ----------------------------- ----------------------- ------------ ----------------------

> 撮合模块关键链路上的内存表容量统计：

------------------------ ----------------------- --------------------------- ----------------------- ------------ ----------------------
         **内存表**         **表记录大小(bytes)**   **会员/客户总数（活跃）**   **最大合约数(活跃）**   **日委托**   **最大内存占用(GB)**
    
         客户限仓表                  36                      600000                     3000                                60.35
    
       客户限仓使用表                48                      600000                     3000                                80.47
    
       客户交易持仓表                68                      600000                     3000                                113.99
    
     客户合约开仓限额表              16                      600000                     3000                                26.82

   客户合约开仓限额使用表            16                      600000                     3000                                26.82

           委托表                    248                                                                100000000           23.10
------------------------ ----------------------- --------------------------- ----------------------- ------------ ----------------------

> 在核心交易业务处理过程中，有大量数据存储在内存数据库中，部分内存表随着委托量、成交量、客户数、会员数、合约数等指标的增长，表记录数会大规模增加，内存表规模增加后，表数据查询性能会出现下降。新一代交易系统业务层通过表拆分和减少查询次数降低表规模增加后对性能的影响。
>
> （1）对规模较大的内存表进行拆分处理，缩小单个表的规模。在实时风控模块，上述关键内存表中，以下表按照交易会员进行分表：

------------------------
  委托表

  客户交易持仓表

  交易持仓明细表

  成交表

  场上客户优惠组合持仓表

  委托表

  客户限仓使用表

  场上客户套利持仓表

  持仓明细表

  优惠组合持仓表
  ------------------------

> 在撮合模块，可对订单表按照交易会员进行分表：

2.  > 减少查询次数，对同一事务内的多个内存表进行索引关联，通过一次查询找到多个表的数据。

    1.  []{#_Toc1861495929 .anchor}**行情、深度行情容量分析**

> 适配当前容量要求，优化行情发送服务确保行情能在规定时间内发送完毕。
>
> 行情与深度行情主要考虑内存容量和性能容量。

#### 内存容量分析

> **容量分析**
>
> 内存容量主要包括：行情数据存储容量，行情快照数据存储容量，TCP连接开销容量。

+:--------------------------------------------:+:-------------:+:------------:+:------------:+
| > 基本参数                                   | > 符号        | > 业务最大值 | > 测试最大值 |
+----------------------------------------------+---------------+--------------+--------------+
| > 席位数                                     | > $$N_{t}$$   | > 8000       | > 1000       |
+----------------------------------------------+---------------+--------------+--------------+
| > 基本合约数                                 | > $$N_{cb}$$  | > 30600      | > 255\*      |
+----------------------------------------------+---------------+--------------+--------------+
| > 套利合约数                                 | > $$N_{ca}$$  | > 150000     | > 1245\*     |
+----------------------------------------------+---------------+--------------+--------------+
| > 合约数（基本合约+套利合约）                | > $$N_{c}$$   | > 180600     | > 1500       |
+----------------------------------------------+---------------+--------------+--------------+
| > 委托数                                     | > $$N_{o}$$   | > 800000000  | > 100000000  |
+----------------------------------------------+---------------+--------------+--------------+
| > 最大价位数量                               | > $$N_{r}$$   | > 2000\*     | > 2000\*     |
+----------------------------------------------+---------------+--------------+--------------+
| > 撤单率                                     | > $$R_{w}$$   | > 0.8\*      | > 0.8\*      |
+----------------------------------------------+---------------+--------------+--------------+
| > 一个行情前置（深度行情前置）的工作线程数量 | > $$N_{tc}$$  | > 5\*        | > 5\*        |
+----------------------------------------------+---------------+--------------+--------------+
| > 一个TCP连接的内存空间                      | > $$M_{tcp}$$ | > 60 KB\*    | > 60 KB\*    |
+----------------------------------------------+---------------+--------------+--------------+

> 下表汇总了各基本参数的符号定义及其峰值边界。其中，常规数值代表经业务/测试验证的实证数据，带星号（\*）数值代表基于系统模型的推算数据。
>
> 考虑所有报单都没有成交，这样会导致最坏的内存情况，在这种情况下，基本行情的内存容量如下表所示：

+:----------------------:+:------------------------:+:---------------------------------------------------:+:------------:+:-------------:+
| > 容量需求             | > 对应模块               | > 内存容量（Bytes）                                 | > 业务最大值 | > 测试最大值  |
+------------------------+--------------------------+-----------------------------------------------------+--------------+---------------+
| > 行情数据存储容量     | > 行情服务（或行情前置） | > $$692N_{cb} + 649N_{ca} + (583 + 364N_{r})N_{c}$$ | > 122.656 GB | > 1.0187 GB   |
+------------------------+--------------------------+-----------------------------------------------------+--------------+---------------+
| > 行情快照数据存储容量 | > 行情前置               | > $${800N}_{c} \ast \ N_{tc}$$                      | > 0.136 GB   | > 0.00112 GB  |
+------------------------+--------------------------+-----------------------------------------------------+--------------+---------------+
| > TCP连接开销容量      | > 行情前置               | > $$N_{t} \ast M_{tcp}$$                            | > 0.447 GB   | > 0.0559 GB   |
+------------------------+--------------------------+-----------------------------------------------------+--------------+---------------+

> 其中行情数据存储容量的组成为：行情数据存储容量 = 合约表容量（$188N_{cb}$）+ 套利合约表容量（$166N_{ca}$） + 行情索引表容量（$24N_{c}$） + 最优行情存储表容量（$252N_{cb}$） + 套利最优行情存储表容量（$183N_{ca}$） + 普通合约乘数因子表容量（$24N_{c}$） +错峰行情相关分配表容量（$32N_{c}$） + 合约变化表（$4N_{c}$） + 历史波动率容量（$88N_{c}$）+ 计算参数表容量（$360N_{c}$） + 连续交易暂停表容量（$252N_{cb}$） + 期权系列表容量（$51N_{c}$） + MBL表容量（$182N_{r}N_{c}$） + 交易暂停MBL表容量（$182N_{r}N_{c}$）
>
> 深度行情的内存容量需求如下表所示：

+:----------------------:+:--------------------------------:+:-------------------------------------------------------------------------:+:------------:+:------------:+
| > 容量需求             | > 对应模块                       | > 内存容量（Bytes）                                                       | > 业务最大值 | > 测试最大值 |
+------------------------+----------------------------------+---------------------------------------------------------------------------+--------------+--------------+
| > 行情数据存储容量     | > 深度行情服务（或深度行情前置） | > $$692N_{cb} + 649N_{ca} + (763 + 364N_{r})N_{c} + 643N_{o}(1 - R_{w})$$ | > 218.500 GB | > 13.996 GB  |
+------------------------+----------------------------------+---------------------------------------------------------------------------+--------------+--------------+
| > 行情快照数据存储容量 | > 深度行情前置                   | > $$963N_{c} \ast N_{tc}$$                                                | > 0.162 GB   | > 0.00135 GB |
+------------------------+----------------------------------+---------------------------------------------------------------------------+--------------+--------------+
| > TCP连接开销容量      | > 深度行情前置                   | > $$N_{t} \ast M_{tcp}$$                                                  | > 0.447 GB   | > 0.0559 GB  |
+------------------------+----------------------------------+---------------------------------------------------------------------------+--------------+--------------+

> 其中深度行情的行情数据存储容量的组成为：深度行情数据存储容量 = 基本行情数据存储容量（$692N_{cb} + 649N_{ca} + (583 + 364N_{p})N_{c}$） + 订单链表容量（$433N_{o}(1\  - \ R_{w})$） + 订单Map容量（$210N_{o}(1\  - \ R_{w})$） + 实时结算价容量（$100N_{c}$） + 成交表容量（$(80 + N_{p})N_{c}$）

#### 性能容量分析

> 内存容量主要包括：逐笔行情更新性能，行情切片性能、切片发送性能与快照发送性能。

1.  > 逐笔行情更新提供的服务和性能如下表所示：

+------------------------------------------+--------------------------------------------------------+--------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------+
| > 具体行情                               | > 所属行情模块                                         | > 更新或维护方式                                                                                             | > 最坏复杂度                                                      |
+------------------------------------------+--------------------------------------------------------+--------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------+
| > 深度行情与套利深度行情                 | > 深度行情、基本行情（仅用于更新最优行情，不对外发送） | > 利用红黑树维护，key为{合约号、买卖方向与价格}                                                              | > $$O(log(2 \ast N_{c} \ast N_{r}))$$                             |
+------------------------------------------+--------------------------------------------------------+--------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------+
| > 最优行情与套利最优行情                 | > 基本行情、深度行情                                   | 1.  > 直接复制撮合传过来的成交回报；\                                                                        | > $$O(log(2 \ast N_{c} \ast N_{r}))$$                             |
|                                          |                                                        |     > 2. 基于深度行情更新最优买和最优卖的数据                                                                |                                                                   |
+------------------------------------------+--------------------------------------------------------+--------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------+
| > 实时结算价行情                         | > 深度行情                                             | > 直接复制最优行情的AvgPrice字段                                                                             | > $$O(1)$$                                                        |
+------------------------------------------+--------------------------------------------------------+--------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------+
| > 分价位成交量行情                       | > 深度行情                                             | > 利用双层红黑树维护（第一层的key为合约号，第二层的key为价格）                                               | > $$O(log(N_{c} \ast N_{r}))$$                                    |
+------------------------------------------+--------------------------------------------------------+--------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------+
| > 委托统计行情                           | > 深度行情                                             | > 利用双层红黑树维护，key为合约号                                                                            | > $$O(log(N_{c}))$$                                               |
+------------------------------------------+--------------------------------------------------------+--------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------+
| > 最优价位前十笔委托（直接市场委托行情） | > 深度行情                                             | > 1\. 第一层是一个vector维护每一个合约的委托链表；                                                           | > $$O(N_{c}) + O(N_{maxlen(O)})$$                                 |
|                                          |                                                        |                                                                                                              |                                                                   |
|                                          |                                                        | > 2\. 第二层是一个委托链表，这是一个双层链表，第一层按价格排序，第二层按时间排序（第二层可以被视为一个队列） | > （撤单的时候性能最差，$maxlen(O)$指所有合约中，最多的报单数量） |
+------------------------------------------+--------------------------------------------------------+--------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------+

2.  > 行情切片提供的服务和对应的性能如下表所示：

+----------------------------------------+-----------------------+---------------------------------------------------+
| > 具体行情切片                         | > 所属行情模块        | > 最坏情况切片的复杂度（所有合约都有改动）        |
+----------------------------------------+-----------------------+---------------------------------------------------+
| > 最优行情或套利最优行情切片           | > 基本行情、深度行情  | > $$O(N_{c})$$                                    |
+----------------------------------------+-----------------------+---------------------------------------------------+
| > 深度行情或套利深度行情               | > 深度行情            | > $$O(log(2 \ast N_{c} \ast N_{r}))$$             |
+----------------------------------------+-----------------------+---------------------------------------------------+
| > 期权参数行情切片                     | > 基本行情、深度行情  | > $O(N_{c} \ast k)$或 $O(N_{c} \ast k^{2})$       |
|                                        |                       |                                                   |
|                                        |                       | > 其中k为迭代次数，复杂度根据使用的模型不同而变化 |
+----------------------------------------+-----------------------+---------------------------------------------------+
| > 实时结算价行情                       | > 深度行情            | > $$O(N_{c})$$                                    |
+----------------------------------------+-----------------------+---------------------------------------------------+
| > 分价位成交量行情切片                 | > 深度行情            | > $$O(N_{c} \ast N_{p}(1\  + \ log(N_{p})))$$     |
+----------------------------------------+-----------------------+---------------------------------------------------+
| > 委托统计行情切片                     | > 深度行情            | > $$O(N_{c} \ast log(N_{c}))$$                    |
+----------------------------------------+-----------------------+---------------------------------------------------+
| > 最优价前十笔行情（直接市场委托行情） | > 深度行情            | > $$O((N_{c})^{2})$$                              |
+----------------------------------------+-----------------------+---------------------------------------------------+

3.  > 行情切片发送性能：设$strc(N_{b})$为序列化一个字节数为$N_{b}$的Field的时间复杂度（$strc(N_{b})$约为$O(N_{b})$），$unstrc(N_{b})$为序列化一个字节数为$N_{b}$的Field时间复杂度（$unstrc(N_{b})$约为$O(N_{b})$）。行情发送提供的服务和对应的性能如下表所示：

+------------------------------------------------------------------------------------------------------------+-----------------------+---------------------------------------------+
| > 具体切片发送服务                                                                                         | > 所属行情模块        | > 最坏时间复杂度                            |
+------------------------------------------------------------------------------------------------------------+-----------------------+---------------------------------------------+
| > 更新行情快照                                                                                             | > 基本行情、深度行情  | > $$O(N_{c})$$                              |
+------------------------------------------------------------------------------------------------------------+-----------------------+---------------------------------------------+
| > 发送增量最优行情或增量套利最优行情切片                                                                   | > 基本行情            | > $$O(N_{c} \ast (22 + strc(252) + N_{t})$$ |
+------------------------------------------------------------------------------------------------------------+-----------------------+---------------------------------------------+
| > 发送深度最优行情或套利深度最优行情切片（最优行情、深度行情、期权参数行情与最优价前十笔行情打包一起发送） | > 深度行情            | > $$O(N_{c} \ast N_{t})$$                   |
+------------------------------------------------------------------------------------------------------------+-----------------------+---------------------------------------------+
| > 实时结算价行情切片                                                                                       | > 深度行情            | > $$O(N_{c} \ast N_{t})$$                   |
+------------------------------------------------------------------------------------------------------------+-----------------------+---------------------------------------------+
| > 分价位成交量行情切片                                                                                     | > 深度行情            | > $$O(N_{c} \ast N_{t})$$                   |
+------------------------------------------------------------------------------------------------------------+-----------------------+---------------------------------------------+
| > 委托统计行情切片                                                                                         | > 深度行情            | > $$O(N_{c} \ast N_{t})$$                   |
+------------------------------------------------------------------------------------------------------------+-----------------------+---------------------------------------------+

4.  > 行情快照发送性能：深度行情和基本行情的快照有两个不同之处。 第一，快照内容区别，基本行情前置只存储最优行情快照，深度行情前置则会存储最优行情快照、期权参数行情快照、最优价前十笔行情快照和深度行情快照（即深度最优行情的快照）。

    > 第二，快照存储形式的区别，基本行情直接存储最优行情报文，而深度行情以内存对象的形式保存。

    > 这些区别导致这两个行情前置发送行情快照的复杂度存在区别，若要给所有席位发送快照，两者时间复杂度如下表所示：

+-----------------------------------+-----------------------------------------+
| > 行情快照类型                    | > 最坏时间复杂度                        |
+-----------------------------------+-----------------------------------------+
| > 基本行情快照                    | > $$O(N_{c} \ast N_{t})$$               |
+-----------------------------------+-----------------------------------------+
| > 深度行情快照                    | > $$O(N_{c} \ast (strc(963) + N_{t}))$$ |
+-----------------------------------+-----------------------------------------+

> 其中"$strc(963)$"是将深度行情快照数据序列化为报文的复杂度。

## 容量及性能优化

### 初始化文件加载

> 按照容量指标实现交易系统加载对应数据量级初始化文件的能力，针对性地优化初始化文件结构和加载速度。

1.  > 将初始化文件拆分，每个模块有单独的初始化文件，通过模块粒度管理所有初始化数据。初始化文件命名规则如下：

    > \<xxx\>\<date\>.dat,\<xxx\>为各个模块名称，\<date\>为具体日期。

    > 示例：

    > Fund20250114.dat

    > Match120250114.dat

    > \...\...

    > MarketData20250114.dat

2.  > 按照"模块-初始化文件表"的方式设计订阅表，推送对应的初始化文件给指定的模块。订阅表设计规则如下：

    > \<模块_ip/index, 模块名称/Bin名称，IP，目录名, 初始化文件列表\>

    > 示例：

    > {

    > "fund_ip": \["fund", "172.21.16.118", "t_fund", \["Fund20250114.dat"\],

    > "match1_ip":\["match1","172.21.16.119","t_match/match1",

    > \["Match120250114.dat"\]\]

    > }

> 3.单文件优化后，还需调整系统启动流程，确保系统的整体启动速度符合要求。
>
> 备注：操作系统限制了单文件大小，目前容量指标里的要求可能无法实现。

### 2.1.2.初始化文件分发模块

> 适配"模块-初始化文件表"的订阅表，能推送文件到对应模块

1.  > 设计新的文件订阅和分发服务替换原本的filetrans，不再使用ftp，通过rsync方式传输文件到对应模块。示意图如下：

    > ![filetrans_rsync](media/image2.png){width="5.226388888888889in" height="2.8854166666666665in"}

    > 整体传输流程主要分为三部分：第一部分为运维脚本启动初始化文件生成模块，按照一个模块名称一个初始化文件的颗粒度生成初始化文件。第二部分为初始化文件的分发。因为场下的机器与场上的机器之间有防火墙的隔离，所以初始化文件无法直接通过部署在初始化文件生成机器中的初始化文件分发模块直接分发到所有场上的目标机器中。解决方案为：将整个传输过程拆分为两个阶段。第一阶段：部署在初始化文件生成机器中的初始化文件分发模块先将所有初始化文件传输到场上的某台中转机器中。第二阶段：在场上的中转机器中部署第二个初始化文件分发模块，由它将初始化文件分发到具体的目标机器中。第三部分为具体的应用设备模块加载它所需要的初始化文件。

> 2.增加文件校验功能。由于使用rsync协议进行初始化文件的传输，rsync内部机制自带文件完整性校验功能，因此无需额外开发此功能，只需要选择合适的rsync参数来执行rsync命令即可。
>
> 3.增加并发传输功能。分发模块将采用C++来开发实现，尽量采用一个线程绑定一个CPU核心的方式进行并发传输。初始化文件分发的两个阶段也有所不同。第一个阶段中，所有初始化文件只有一个目标机器，是多对一的映射关系。第二个阶段中，不同的初始化文件需要被分发到不同的机器中，是多对多的映射关系。如下图所示：
>
> ![并发配置1](media/image3.png){width="2.140972222222222in" height="1.9375in"} ![并发配置2](media/image4.png){width="2.0729166666666665in" height="1.9027777777777777in"}
>
> 无论是第一阶段还是第二阶段中，都可以将所有\<初始化文件，目标路径\>映射关系组成的传输任务平均分配到各个传输线程中执行。
>
> 4.增加断点重传功能。由于rsync自带断点重传功能，因此初始化分发模块的实现上只需要重复执行rsync传输命令即可对文件进行断点重传。重传机制可以设计为：如果存在初始化文件没有被成功传输，那么将一直重复执行rsync命令，直至所有初始化文件被成功传输。同时，可以配置最大允许重传次数，防止在一些特殊情况下，初始化文件一直没能被成功传输，导致程序进入死循环。如果程序到达最大重传次数并且尚未完成所有初始化文件的传输，那么程序需要记录失败日志，以及rsync返回的错误状态码，以供后续排障和人工手动重传初始化文件使用。

1.  []{#_Toc99453369 .anchor}**会员连接管理与资金分组**

<!-- -->

1.  **前置：**在新一代交易系统中，前置进行多线程重构来提升整体的吞吐量并优化通信时延，交易前置中有多个工作线程处理席位的委托、撤单及成交。为保证各线程间委托量差异过大导致单线程处理时延过高，需要为交易前置增加负载均衡处理。

2.  **资金：**在新一代交易系统中，资金使用多线程架构处理业务，连接的会员将被分至不同的线程进行处理，以提高效率。为防止资金处理业务时各线程间委托量差异过大导致负载不均衡，需要为资金的会员连接管理处增加负载均衡处理。

#### 负载均衡设计

**交易前置加载**

数据库中需要新增一个数据表，记录各个席位前n天的委托报单量与委托撤单量的总和。在场下系统交易初始化生成初始化文件后，将此表加载到初始化文件中，载入交易系统。席位-委托撤单量表的结构如下：

----------------------- ----------------------- -----------------------
  序号                    席位号                  前n天（委托+撤单量）


----------------------- ----------------------- -----------------------

**交易前置负载均衡设计**

交易前置加载初始化文件时，加载席位-委托撤单量表到前置的各个工作线程中，将表中对应委托量与撤单量值作为当日席位该席位的负载值。

当有席位接入交易前置时，连接管理线程寻找各线程中当前负载最小的工作线程，将席位与该工作线程建立连接，并将该工作线程的当前负载增加该席位对应的负载值。

当席位退出登录断开连接后，与其连接的工作线程的负载值需要减少该席位的负载值。

**资金加载初始化文件**

在资金加载初始化文件时，数据库中需要新增一个数据表，记录会员历史委托量。该表包含会员号和该会员在T日前的5个交易日的委托量之和。在场下系统交易初始化生成初始化文件后，将此表加载到初始化文件中，载入交易系统。表的结构如下：

----------------------- ----------------------- -----------------------
  类型                    字段                    描述

  char\[9\]               MemberID                会员号

  int\[5\]                OrderQty                5日委托量
----------------------- ----------------------- -----------------------

**资金会员管理负载均衡设计**

算法以减少最大负载会员分组和与最小负载会员分组的负载和之间的差值（负载差）为优化目标。负载以每个会员前5日的平均委托量作为数据参考。

算法采用贪心算法策略：先把会员按委托量的值从大到小排序，然后依次把每个元素放到当前和最小的那个组（用堆维护每组当前和），当组和相等时，用组 id 作为次级比较保证算法的稳定性。最后，即可输出较为平均的负载分组方案。

# 第三章 容错及兼容性需求描述

# **业务功能**需求列表

------ ------------ ----------------- ------------------------------------------------------------------------------
  序号   模块         业务功能          功能描述

  1      统一登录     踢席位            增加指定设备号踢席位的功能，实现只踢故障前置上维护的登录用户

  2      统一登录     席位状态维护      增加席位、设备号、设备组号、通道号等字段关联，可以提供多种查询和踢席位的接口

  3      踢席位工具   指定设备号        可以指定设备号踢席位，包括交易、行情、深度行情前置

  4      前置         延迟加入模式      向总线发起查询，获取可以使用的新设备号，然后用新的设备号连接总线

  5      总线         延迟加入模式      支持查询可用新设备号

  6      兼容前置     API兼容性         开发兼容交易、行情、深度行情前置支持老版本API到新协议的转换

  7      readbak      readbak传输升级   
------ ------------ ----------------- ------------------------------------------------------------------------------

# **业务功能需求描述**

\[概括性描述\]

\[按业务类别详细描述业务功能需求, 根据项目涉及业务范围进行裁剪\]

## 前置支持延迟加入

> 该非功能需求主要涉及两类场景：
>
> **场景一：**现有交易系统的交易、行情前置异常退出时，若前置内部维护的席位连接未能在前置异常退出之前向交易系统发起用户登出，那么资金或行情服务就无法感知到前置退出导致的席位断开。当前系统的设计导致故障前置重启后，若该前置维护的席位仍然选择通过这个前置入口连接交易所的交易系统。新的登录请求到达资金或行情服务后，会和上次未正常登出的状态发生冲突，交易系统将清理原登录连接并对新登录连接返回失败。
>
> 上述场景目前无法通过程序直接解决，需要靠运维人员在故障前置重启前使用踢席位工具来释放资金或行情模块中的席位连接。
>
> **场景二：**开启夜盘后，交易系统的运行将不再连续，周五的夜盘是下周一交易日的一部分，但由于目前系统的状态切换依托时钟触发来实现，到指定时间自动切换交易状态到开市，估无法横跨周末两日。为了避免故障，周末需要关闭系统，在周一早晨进行全系统的反演启动。这时除了踢席位外，还需要手工修改配置文件中的设备号，并清理所有前置设备的流水文件，让断点归零。
>
> 针对以上两个场景，运维认为应该支持前置模块的延迟加入，具体体现为以下两个功能：

1.  > 实现前置模块延迟加入，不需要修改前置和总线的配置文件，可以通过参数指定加入模式，动态增加新的前置。前置重启限制只在交易暂停阶段实施，不能影响总线性能。

2.  > 增加按设备号踢席位的功能，遇到单台前置故障时，可以借助工具完成该设备原席位的手工踢出。

    1.  []{#_Toc1236612721 .anchor}**统一登录与踢席位需求描述**

> 当前踢席位工具的实现原理如下图：

![图 6 当前踢席位工具的实现原理](media/image5.png){alt="D:\\文档\\新一代交易系统\\非功能\\踢席位.drawio.png踢席位.drawio" width="5.7625in" height="4.154861111111111in"}

> 踢席位请求由交易前置接收，经由总线转发，最终实现踢资金、行情、深度行情上的所有席位，并将结果由所有前置通知到每个外部用户。新一代交易系统要实现统一登录服务，所有席位的登录状态最终都由统一登录服务进行集中管理，不再分散维护，数据流发生较大改变。此外需要增加指定故障前置设备号，只踢该前置维护的席位的功能。

2.  []{#_Toc1439358068 .anchor}**前置延迟加入需求描述**

> 当前基于消息订阅和发布的总线架构中，前置服务异常退出后，为了维护系统的数据一致性和防止消息错乱，建议修改为新的设备号后重新连接，依据如下：

------------------------ ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  依据项                   说明

  防止旧会话或状态残留     设备号是前置服务在总线上的唯一标识。异常退出时，总线可能未来得及清理其相关资源（如消息队列、临时订阅），仍保留着旧设备连接的状态（如订阅关系、消息队列、断点号）。新连接使用相同设备号可能被视为旧会话恢复，导致接收到过期或错乱消息，修改设备号可帮助系统将新连接识别为全新实体，避免与残留资源冲突

  保证断点号续传的准确性​   系统维护断点号以保证数据一致性。若前置自身流水不正常时，总线从断点开始续传数据可能无法恢复。修改设备号可强制启动全新数据流，避免混淆
------------------------ ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

> 由于新一代交易行情前置内增加了下行流水订阅的功能，相比上一代交易系统多了流水存储的要求，因为需要为新一代前置增加一个接入模式，在该模式下既可以将每个前置作为独立设备管理，同时每个设备具备流水订阅断点重传的能力。为实现前置延迟加入，在该模式下，除了使用本地设备号外，还增加从总线获取一个未使用过的新设备号的功能，前置能以该设备号重连总线，而非继续使用本地配置文件中的设备号。

## readbak传输升级

> 提升readbak向灾备中心传输数据的能力，优化读取流水文件速度，应该能跑满网络带宽上限。
>
> 1.优化readbak读取文件的性能；
>
> 2.readbak读写分离，加快发送速度；
>
> 3.尝试DPDK等方式；
>
> 4.支持流控。

## API发布升级兼容性

> API发布升级需要保证对外兼容性，估新一代交易系统上线需要同步实现新旧API版本的无缝过渡，在兼容期内应当保障包括未升级用户在内的所有用户在业务连续性与体验上的一致性，可以通过fens配置切换流量。​

1.  []{#_Toc1948806827 .anchor}**API兼容性需求**

> 1.协议转换兼容性需求
>
> 兼容前置需实现上行转换，将旧版API字段映射为新版内部格式；下行转换将后台响应适配回旧版API格式发回。
>
> 2.公平性保障需求
>
> 在上行消息的处理方面，新前置和兼容前置处理请求需遵循相同的两级公平性策略，上行数据通过多线程的方式承接，相应速度保持接近，能避免因接入路径不同导致延迟差异。
>
> 此外，考虑到用户升级是逐步的，新旧前置应能按照最新的用户情况调整资源分配，通过灵活的扩缩容确保对应用户群体的流量峰值和前置数量保持匹配，不影响整体系统公平性。
>
> 3.下行数据兼容性转换需求
>
> 交易前置下行数量格式暂无调整，保持兼容前置的下行流控能力即可。行情前置下行数据需要具备过滤机制，行情与深度行情的兼容前置需自动过滤新版系统新增字段，确保返回给旧版API用户的数据包结构与历史版本完全一致。
>
> 此外，行情数据受架构调整影响，新旧前置的行情数据在时间上应一致。

2.  []{#_Toc175757345 .anchor}**兼容前置设计​**

> 新旧前置基于同一套底层架构实现，仅在API上下行数据的处理中有差异，其他业务和非功能逻辑均相同，整体上确保系统行为一致性，此外新旧前置共享同一套身份验证与权限管理体系，均通过统一登录模块登录交易系统，用户数据不隔离，**支持日内用户切换新旧前置**。
>
> 前置升级可以通过fens配置文件实现流量调度，按照用户的迁移情况逐步引导用户登录新版本前置。并通过前置事件日志和性能日志可以直接监控新老API请求的流量分布和延迟等指标。
>
> ![席位接入.drawio](media/image6.png){width="5.764583333333333in" height="2.05625in"}

# 第四章 运维管理需求

# 业务功能需求列表

------ ---------- -------------------- ------------------------------------------------------------------------------------------------------
  序号   模块       业务功能             功能描述

  1      交易系统   日志写入性能优化     重新设计日志组件架构，优化日志组件性能，降低对系统整体性能的影响

  2      交易系统   日志分级与分类优化   实现日志的精细分类，提高大数据量场景下的排障速度；按照运维要求优化日志级别，增加非故障监控用日志级别

  3      交易系统   日志内容转换         压缩日志内容，通过降低可读性换取更优的性能

  4      交易系统   系统日志拆分         分离平台日志与业务日志，将系统运行事件日志独立为单独文件

  5      交易系统   日志清理             梳理现有代码，清理无用和冗余的日志输出

  6      交易系统   性能日志配置化       实现性能日志计算方式的可配置化，提高运维和测试的灵活性

  7      交易系统   登录时延监控         记录席位登录时间，用于记录测试数据

  8      交易系统   模块状态监控         完善对服务运行状态的日志监控功能，实现全面的健康检查

  9      交易系统   订单时延监控         基于现有RTT采样，实现逐笔委托的软件耗时记录

  10     交易系统   内存监控             增加服务器内存、内存队列、内存表等不同粒度的监控
------ ---------- -------------------- ------------------------------------------------------------------------------------------------------

# 业务功能需求描述

\[概括性描述\]

\[按业务类别详细描述业务功能需求, 根据项目涉及业务范围进行裁剪\]

运维管理方面，涉及高性能日志系统、监控需求等对象。

高性能日志系统，当前系统日志组件采用同步写入模式，尽管能够保证日志的完整性与可靠性，但在高频交易场景下会显著增加线程阻塞和处理时延，成为系统性能瓶颈。为解决这一问题，高性能日志组件将作为核心基础设施，承担系统运行状态、交易过程、性能指标及故障信息的记录任务，并在保证日志完整性的前提下，最大限度降低对业务处理的影响，同时提供实时监控与快速故障定位能力。高性能日志系统整体包括多级别日志分类、高并发写入、内存优化和实时监控等特性，以确保在极端市场条件下系统的稳定运行。

监控需求建设，随着广州期货交易所交易业务量的持续增长，现有交易系统在高频交易和极端行情下面临性能瓶颈与运维压力。系统在处理大量订单、行情数据及交易指令时，日志写入延迟、内存使用异常和模块状态不可见等问题容易影响交易稳定性和故障定位效率。为保障系统的高可用性、低延迟及可观测性，亟需构建新一代高性能日志组件和全面的监控需求，实现对系统运行状态、核心模块、内存资源等的实时监控与预警。

## 高性能日志系统

当前系统日志组件采用同步写入模式，尽管能够保证日志的完整性与可靠性，但在高频交易场景下会显著增加线程阻塞和处理时延，成为系统性能瓶颈。为确保日志系统自身不会成为交易系统的性能瓶颈，其设计从架构和I/O路径等方面进行了重新设计：

1.  异步架构与无锁队列：采用基于单生产者单消费者无锁队列的异步架构，将日志的产生与消费彻底分离，在保证日志完整性的前提下，有效削减大量同步写入开销；

2.  I/O优化与批量刷盘：后端线程采用批量写入策略，通过缓冲区聚合多条日志后统一刷盘，显著降低系统调用频率和磁盘I/O开销；

3.  性能日志异步写入：对于性能统计日志，采用异步写入模型，使其与交易主线程彻底解耦，避免峰值时期指标采集反向占用关键路径资源。

### 日志系统设计

本日志系统设计以性能为核心，借鉴异步框架的理念，提供一个对应用主线程影响最小、具备高吞吐能力的日志解决方案，确保日志记录调用在主应用线程中的延迟时间趋近于零；同时，能够处理每秒数百万条日志消息的写入需求。

系统采用基于单生产者单消费者无锁队列的异步架构，实现 I/O 隔离：

1.  生产者（用户线程）： 日志消息在用户线程中构造后，通过无锁机制快速提交到缓冲区。该过程不涉及任何阻塞 I/O 或锁竞争。

2.  消费者（专用线程）： 一个专用的后台写入线程独立工作。它们负责从缓冲区批量取出消息，进行格式化处理，并将数据安全地写入到磁盘。

    本系统将通过以下关键机制保障高性能、可靠性与灵活性：

<!-- -->

1.  线程安全： 整个日志调用链从前端到后端均设计为线程安全。前端使用无锁结构避免用户线程间的竞争；后端由单一写入线程独占，自然实现 I/O 线程安全。

2.  文件输出与日志滚动： 默认支持高效的文件输出。内置日志滚动机制，可根据文件大小或时间间隔自动切换日志文件，简化日志管理。

3.  异常处理机制： 在系统发生异常崩溃时，能捕获并记录崩溃信号，在程序退出前尽最大努力交付所有待输出日志。

4.  编译时优化： 充分利用 C++ 模板和 constexpr 特性，实现日志宏的编译时优化，例如对不活跃的日志级别进行零开销过滤，进一步提升运行效率。

本系统要求 C++17 及以上标准，并依赖底层操作系统提供的高精度时钟和线程同步原语来保证性能和时间戳的精确性。

![mermaid-diagram-2025-11-19-003225](media/image7.png){width="5.597222222222222in" height="8.652083333333334in"}

图 7 日志系统架构设计

### 系统日志拆分

> 为提升系统的可观测性、排障效率和运行稳定性，日志体系将系统运行事件日志独立为单独文件，按功能与用途划分为三类：事件日志、性能日志与系统运行日志，并结合异步写入机制实现高吞吐与低延迟。
>
> 1\. 事件日志
>
> 记录所有与业务流程相关的关键事件，用于实现业务级追踪与问题还原。包括：资金事件、撮合事件等核心业务路径信息。
>
> 2\. 性能日志
>
> 用于衡量系统运行效率与资源消耗，支撑性能诊断和容量规划。\
> 覆盖：内存/网络/I/O 指标、吞吐量统计、模块处理延迟等。
>
> 3\. 系统运行日志(XXXSys.log)
>
> 反映系统整体运行状态与异常情况，为稳定性与运维提供依据。\
> 包括：启动/关闭、关键模块初始化、主备切换、异常与错误处理、心跳与告警、TCP连接、组播加入/剔除等。

### 日志分级与分类优化

> 根据运维侧对于"非故障但必须记录"的运行事件要求，日志系统在原有分级基础上新增 MONITOR 日志级别，用于记录具有重要业务含义或潜在风险但尚未构成错误的关键事件。

1.  > 日志分级与分类优化，新增 MONITOR 监控日志级别，用于必要监控事件（如主备切换、关键队列溢出）。

#### 日志级别定义

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  级别      数值   含义                             使用规则                                                     处理要求
--------- ------ -------------------------------- ------------------------------------------------------------ -----------------------------------------------------------
  MONITOR   6      关键性能指标监控与组件状态追踪   用于记录模块生命周期、核心资源使用和连接状态等关键数据点。   日志本身不触发应用内告警,用于趋势分析、容量规划和外部告警

  FATAL     5      系统不可恢复错误                 仅记录不可恢复的严重故障，必须停止系统运行                   立即人工干预，系统可能需要重启

  ERROR     4      业务逻辑错误                     记录导致功能失败的错误，但系统仍可继续运行                   影响单个请求但系统仍可运行，需要监控和处理

  WARN      3      潜在风险预警                     记录可能影响系统稳定性的异常或风险信号                       需要监控，暂无需立即处理，必要时优化调整

  INFO      2      核心业务流程                     记录系统关键状态、流程和结果性信息                           审计追踪，状态记录

  DEBUG     1      开发调试信息                     记录详细的调试和诊断信息                                     默认关闭，仅在定位问题时启用
  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------

### 日志内容转换提升性能

> 为进一步降低日志体积、减少 I/O 压力并提升整体写入性能，日志系统引入基于编码的内容压缩机制。其核心思想是在日志写入路径上以结构化编码替代可读文本，在日志平台或开发端进行反向解析，从而实现高性能与可维护性兼得。

1.  > 日志包括错误ID或正常日志，都通过编码的方式记录，减小日志大小；

2.  > 日志中应避免使用中文，在 UTF-8 编码下，汉字占 3 或 4 字节而英文字符仅占 1 字节，英文字符可显著减少存储空间。

#### 日志内容与格式规范

标准格式定义：

时间戳 \| 线程ID \| 日志级别 \| 文件名:行号 函数名｜消息内容=\[错误码\|具体内容\]

%(time)｜%(thread_id)｜%(log_level)｜%(file_name):%(line_number) %(caller_function)｜%(message)

+----------+----------------------------------------+-------------------------------------------------------+
| 字段     | 格式/示例                              | 说明                                                  |
+==========+========================================+=======================================================+
| 时间戳   | 20250915 14:30:25.123456789            | 纳秒精度，格式 YYYY-MM-DD HH:mm:ss.nnnnnnnnn          |
+----------+----------------------------------------+-------------------------------------------------------+
| 线程ID   | 67890                                  | 系统分配的线程标识，十进制表示                        |
+----------+----------------------------------------+-------------------------------------------------------+
| 日志级别 | INFO                                   | 级别：MONITOR, FATAL, ERROR, WARN, INFO, DEBUG        |
+----------+----------------------------------------+-------------------------------------------------------+
| 源码位置 | OrderRspHandle.cpp:455 OrderRspProcess | 文件名:行号 + 函数名，文件名不含路径                  |
+----------+----------------------------------------+-------------------------------------------------------+
| 消息内容 | 0000\|...                              | 结构 = \[错误码\|摘要\|具体内容\]，其中：             |
|          |                                        |                                                       |
|          |                                        | - 错误码：可选字段，用于标识系统或业务错误（如 0000） |
|          |                                        |                                                       |
|          |                                        | - 具体内容：必填字段，携带上下文关键信息              |
|          |                                        |                                                       |
|          |                                        | - 限制：UTF-8 编码(非 UTF-8 with BOM)                 |
+----------+----------------------------------------+-------------------------------------------------------+

格式示例：

20250915 14:30:25.123456789｜67890｜INFO｜OrderRspHandle.cpp:455 OrderRspProcess｜0000\|正确委托单\|系统委托号:XXXXXXXX 本地委托号:XXXXXXXX 会员号:XXXX 席位号:XXXXXXXX 客户号:XXXXXXXX 合约号:siXXXX-C/P-XXXXX

### 性能日志可配置

> 为增强性能指标采集的灵活性，满足不同环境下的运维与测试需求，性能日志的计算与输出方式支持可配置化管理。

1.  > 性能日志可配置化，支持配置文件中设置写入频率（如1s/5s），可以按需调整。

2.  > 设置上下限，缓冲区不能溢出，也不能配置太小影响性能。

    > 通过以上机制，可在不同场景下实现性能日志的可控、可调与可观测，兼顾数据及时性与系统稳定性。现有日志体系需要进行两项改动：

<!-- -->

1.  将性能日志的写入频率配置化，允许用户在配置文件中灵活设定（例如默认 1s），从而优化性能数据的采集与分析；

2.  将当前直接依赖 C 标准库 FILE指针的同步文件写入方式，替换为高性能异步日志组件，并以 INFO级别输出，实现更高效、更结构化、且级别可控的日志输出。

### 日志清理

对现有代码库进行全面梳理，制定严格的日志输出规范，清理以下类型的无用日志：

1.  冗余调试日志：移除生产环境中不需要的DEBUG级别日志；

2.  重复日志：合并同一操作流程中重复输出的日志；

3.  过期日志：清理与已下线功能相关的日志输出；

4.  敏感日志：移除包含敏感信息的日志，如密码、密钥等；

5.  无效日志：清理格式错误、信息不完整或无法解析的日志。

    同时，确保新提交代码符合日志规范。

## 监控需求

### 登录时延监控

> 为记录席位登录时间并用于测试数据采集，本次对登录时延监控机制进行了如下增强与调整，旨在提升登录过程可观测性，为后续压测分析、故障排查及用户体验优化提供精准数据支撑。

1.  > 登录时延监控精细化，在前置系统与交易网关的登录认证模块入口和出口处，分别植入高精度纳秒级时间戳，实现对每笔席位登录请求的完整时延追踪；

2.  > 旁路计算支持，通过独立的旁路系统实时采集上述时间戳信息，计算并输出席位从发起登录到认证完成的端到端耗时，用于性能分析与异常检测。

3.  > 独立配置与解耦控制，新增登录时延监控专用的配置文件开关，控制粒度独立于通用事件日志及日志级别体系，可按需灵活启停，避免对正常业务日志与系统性能产生影响，满足测试与生产环境的差异化需求。

### 订单时延监控

> 为提升订单链路的性能可观测性与问题定位能力，在现有前置采样 RTT 监控机制基础上，对软件侧订单时延监控进行了细粒度优化，实现了逐笔级别的端到端耗时追踪能力，提升了订单链路时延的可观测深度与定位精度，为性能瓶颈分析、异常延迟复盘以及交易稳定性保障提供了更可靠的数据基础。

1.  > 订单时延监控逻辑优化，将原有基于采样的前置侧 RTT 时延监控机制，优化为逐笔订单级别的时延监控。取消直接输出聚合后的耗时结果，改为对每笔订单关键处理节点进行日志记录，完整保留订单在系统内的全链路时序轨迹。

2.  > 原始时间戳直出，日志中仅打印各关键时点的原始时间戳，不在业务进程内进行时间差计算与格式转换，减少对交易主路径的性能影响。

3.  > 引入旁路系统统一分析，通过旁路分析系统对逐笔时间戳数据进行还原与计算，实现订单最大耗时、分段耗时分布以及异常延迟的统一分析，并支持对丢单场景的辅助定位。

4.  > 独立配置与解耦控制，新增订单时延监控专用的配置文件开关，控制逻辑独立于通用事件日志文件及日志级别体系，可按需灵活启停，在开启逐笔监控能力的同时，避免对现有日志体系和系统性能造成额外影响。

### 模块状态监控

> 为补充对服务运行状态的日志监控，本次对系统运行日志的监控能力进行了扩展和统一管理，确保运行状态、连接状态及日志控制策略具备一致性与可维护性。

1.  > 模块状态监控功能完善，补充对运行状态（初始化状态、主备切换、异常状态）和连接状态（TCP连接、组播节点加入/剔除）等进程级状态的完整监控支持，在系统运行事件日志中增加相关内容；

2.  > 日志的统计和开关都在日志系统实现，交易系统内不单独实现单一子项开关，只有全量开关。

#### 监控范围说明

模块状态监控涵盖系统运行过程中的各类状态信息，原先分散在事件日志、性能日志、统计日志等不同日志文件中的监控内容，现统一整合到系统运行日志中。

模块生命周期监控（原事件日志内容）：

1.  启动状态: 各个程序的启动时间、启动成功率、初始化耗时；

2.  运行状态: 模块运行状态变更、服务可用性检查、健康状态监控；

3.  主备切换: 主备角色切换、切换耗时、数据同步状态、服务恢复时间；

4.  断线重连: 网络断线检测、重连尝试次数、重连成功率、连接恢复时间；

5.  故障退出: 异常退出原因、故障影响范围、恢复处理时间、错误码记录。

系统资源监控（原性能日志内容）:

1.  队列监控: 模块发送队列长度、接收队列长度、队列积压告警、处理速度统计

连接状态监控（原统计日志内容）：

1.  实时连接数: TCP连接数统计、组播节点加入/剔除；

2.  网络流量: 网络流量统计、带宽使用率、数据传输速度、丢包率统计。

### 内存监控

> 为提升系统在高负载场景下的可观测性与运行稳定性，新增多维度内存资源监控能力，覆盖到组件级的监控粒度，强化对内存相关风险的提前感知与快速定位能力。

1.  > 内存资源监控能力新增，新增内存队列监控模块，实现对系统内存使用情况、内存表、无锁队列以及共享内存等关键资源的运行状态监控，提升内存使用透明度。

2.  > 运行期关键操作与异常告警，对盘中动态扩容等关键内存操作进行日志记录与状态跟踪，在出现异常或执行失败时，自动输出告警日志，为快速止损和问题定位提供依据。

3.  > 监控数据采集与输出机制，各内存监控对象在初始化阶段统一注册监控回调接口，由日志系统在运行期按照配置的周期定时触发回调执行，完成监控数据采集与日志输出。该机制避免在业务关键路径中引入额外开销，实现监控逻辑与业务逻辑解耦，并支持后续按需扩展新的监控维度或输出策略。

# 第五章 安全需求描述

# **业务功能**需求列表

+------+----------+---------------+---------------------------+-----------------------------------+
| 序号 | 模块     | 业务功能      | 功能描述                                                      |
+------+----------+---------------+---------------------------------------------------------------+
| 1    | 交易前置 | 国密算法改造  | 明确国密使用场景，数据国密传输，                              |
|      |          |               |                                                               |
|      |          |               | 接口采用国密算法签名与验签，                                  |
|      |          |               |                                                               |
|      |          |               | 登录凭证国密算法处理，                                        |
|      |          |               |                                                               |
|      |          |               | 向场下写入数据透明，存储加密                                  |
+------+----------+               |                                                               |
| 2    | 行情前置 |               |                                                               |
+------+----------+---------------+                                                               |
| 3               | 深度行情前置  |                                                               |
+-----------------+---------------+                                                               |
| 4               | API           |                                                               |
+-----------------+---------------+                                                               |
| 5               | 统一登录      |                                                               |
+-----------------+---------------+                                                               |
| 6               | 同步写/数据库 |                                                               |
+-----------------+---------------+---------------------------+-----------------------------------+
| 7               | API/前置      | 传输通道加密              | 建立国密SSL安全隧道               |
+-----------------+---------------+                           +-----------------------------------+
| 8               | 统一登录      |                           | 会话安全方案，会话信息安全存储    |
+-----------------+---------------+---------------------------+-----------------------------------+
| 9               | API/前置      | 身份认证与访问控制​        | 接入客户端身份强认证              |
+-----------------+---------------+                           +-----------------------------------+
| 10              | 统一登录      |                           | 多因素认证                        |
+-----------------+---------------+                           +-----------------------------------+
| 12              | 同步写/数据库 |                           | 数据库账号与权限精细化管理        |
+-----------------+---------------+---------------------------+-----------------------------------+
| 13              | 统一登录      | 存储数据安全              | 用户口令等凭据加密存储            |
+-----------------+---------------+                           +-----------------------------------+
| 14              | API/前置      |                           | 密钥证书等凭证加密存储            |
+-----------------+---------------+                           +-----------------------------------+
| 15              | 同步写/数据库 |                           | 敏感字段加密存储                  |
+------+----------+---------------+---------------------------+-----------------------------------+
| 16   | API/前置 | 审计范围扩展  | 操作信息落库审计                                              |
+------+----------+               +---------------------------------------------------------------+
| 17   | 统一登录 |               | 登录登出等信息落库审计                                        |
+------+----------+               +---------------------------------------------------------------+
| 18   | 交易网关 |               | 记录并审计场下操作                                            |
+------+----------+---------------+---------------------------------------------------------------+

# **业务功能需求描述**

## 国密算法改造及场景划分

> 为满足等保三级的交易行情系统对数据安全、合规性的要求，需对现有系统的核心模块进行国密算法改造，将原使用的非国密加密/签名算法替换为密评认可的国密算法，以提升交易数据、行情数据、登录凭证、存储数据等的安全性，保障合规运营。
>
> 国密算法的实现需符合国家密码管理局的相关标准和规范，按照使用场景，SM2算法是非对称加密算法，主要用于数字签名、密钥交换和公钥加密。SM3算法是哈希算法，主要用于数据完整性校验、数字签名验证和消息认证码生成。SM4算法是对称加密算法，主要用于数据加密和解密，保证数据机密性。
>
> 按照交易行情系统应用场景划分，**一是**在数据传输安全保障上，交易行情数据传输应使用SM4算法对内容进行加密传输，防止数据在传输过程中被窃取或篡改。交易的委托报入指令还可以采用SM2+SM3组合进行数字签名和加密，确保指令的完整性和不可否认性。**二是**身份认证与访问控制中，应使用SM2数字证书进行身份验证，结合SM3哈希算法验证用户密码，对交易行情API应采用SM2算法进行签名验证，确保接口调用的合法性。三是数据存储安全，使用SM4算法对数据库中的敏感信息（如用户身份信息、数据库账号密码）进行加密存储。四是系统间通信，使用SM4算法对系统间通信数据进行加密传输。
>
> SM2、SM3、SM4算法都支持软件实现，可以通过软件库进行集成。但由于信息系统密码应用基本要求，等保三级系统应采用符合标准的密码模块或通过国家密码管理部门核准的硬件密码产品进行加密，**需要使用硬件加密机。**对于交易行情系统，如必须使用硬件加密机，可以采用混合加密方案。使用硬件加密机进行SM2数字签名和SM4数据加密，其他采用软件加密实现SM3哈希计算。

## 传输通道加密

> 完成国密算法改造后，数据传输（含API通信、数据库连接等场景）采用国密算法（如SM4对称加密）实现全链路覆盖，API通信层统一使用SM4算法对传输数据进行加密，覆盖所有API请求/响应的通信过程。下一步应加强传输通道的安全防护。

### 会话安全保护

> 对交易前置处理的交易数据进行国密算法加密传输，确保交易数据在网络传输过程中不被窃取、篡改。对行情前置处理的行情数据和深度行情数据，如市场最优行情、买卖多档行情、实时结算价、最优前十笔等使用国密算法进行加密传输。确保行情数据在传输过程中的安全性，避免因数据泄露或篡改影响市场公平性。
>
> 对API接口的请求和响应数据进行国密算法（如SM2）签名与验签， 请求方使用国密私钥对API请求数据（如参数、时间戳等）进行签名，确保请求的完整性和来源真实性。API在接入交易系统时，增加国密开关的查询接口，如开启国密加密，API向交易系统传递的上行数据可以按照加密规则处理数据，同时针对前置模块的下行加密包，API接收端同样支持透明无感知的解密，回调接口可以拿到可读可直接使用的有效数据。

2.  []{#_Toc220530438 .anchor}**会话数据加密保护**

> 会话的管理端服务，如包括统一登录、前置在内的关键模块，其内存结构中禁止存储任何明文用户信息，所有用户身份信息、会话数据、认证凭证在内存中必须以加密形式存储，采用国密算法（如SM4）对内存中的用户敏感信息进行实时加密保护。
>
> 用户密码存储时，使用国密算法（如SM3）进行哈希处理（结合盐值），防止密码泄露后被破解；登录凭证（如会话Token）的生成、传输和使用过程中，使用国密算法（如SM4）进行加密，确保凭证的保密性和完整性；登录验证时，使用国密算法对凭证进行验签或解密，验证用户身份的合法性。
>
> 在用户登录成功后，涉及用户敏感信息的字段，也应对进行加密处理存储，不在模块流水或者日志中存储任何未加密的原始数据，保证会话数据安全存储，不会泄露。

3.  []{#_Toc2045780391 .anchor}**通用安全防护​**

> 在API层面对流进交易系统的输入进行统一的通用校验。
>
> 格式处理：输入数据需先进行统一格式处理（如转码、统一大小写），防止通过编码/大小写变换绕过校验。
>
> 白名单机制：按输入需求设置白名单，仅允许符合格式、长度、类型要求的内容；不符合要求的输入直接拒绝。
>
> 危险字符处理：若输入包含潜在危险字符（如\< \> \" \' % ( ) & + \\ \\\' \\\"等），需执行额外安全控制（如输入转义、输出编码），防止注入攻击。
>
> 异常输入监控：记录高频失败请求等异常输入行为，实时触发告警，及时发现攻击尝试。

## 身份认证与访问控制

1.  []{#_Toc1414766090 .anchor}**身份认证功能**

> 由API、前置共同实现"强制身份认证"，对API访问请求进行合法性校验，再由统一登录实现"身份鉴别""密码复杂度管理"等，保障用户登录安全。
>
> 1\. 强制身份认证
>
> 所有API访问需强制进行身份认证，通过合法性校验确保请求来源合法。身份认证保留现有方式：支持"密码 + 授权码"认证供开发测试环境使用，另额外新增认证方式：支持"密码 + 国密CA"认证。
>
> 2\. 身份鉴别
>
> （1）登录校验方式，用户登录系统时，需采用两种或两种以上组合的鉴别技术，仅验证通过后可连接系统进行交易。支持以下2种方式：
>
> 方式1：用户登录密码 + 国密CA认证。
>
> 方式2：用户登录密码 + 校验码认证。
>
> （2）身份标识唯一性，用户身份标识：席位号（8位数字），交易指令唯一标识。 确保身份标识唯一，避免重复或冲突。
>
> （3）密码复杂度管理，只对新改密码做约束，不符合要求的存量不受影响，最低要求如下表：

----------------------- -----------------------------------------------
  配置项                  说明

  密码长度                设置密码小长度（1到20）

  是否有数字              设置则表示密码中必须有数字

  是否有英文字符          设置则表示密码中必须有英文字符

  是否有大写              设置则表示密码中必须有大写字符

  是否有特殊字符          设置则表示密码中必须有特殊字符
----------------------- -----------------------------------------------

> 所有身份验证过程必须在场下执行，并在交易系统的统一登录模块维护器登录状态。
>
> 3\. 加密控制
>
> 密码传输和存储需加密，统一登录模块仅保存通过强加密单向salted哈希算法处理后的密码。
>
> 交易前置、行情前置、Level2行情前置在登录失败时，提示"登录失败"并关闭会话连接。 错误提示信息模糊化处理，不显示具体参数内容，如"密码错误"而非"密码长度不足"。
>
> 登录频次控制：前置端增加登录频次配置功能（单位：次数/每分钟），通过初始化文件向场上提供规则，控制所外客户频繁登录，放在用户故障导致的反复拉流水，影响正常交易。
>
> 席位重复登录时，提示"重复登录"并由统一登录模块控制，将已有席位踢出（和当前生产逻辑一致）；首次登录时，提示并强制修改密码。

2.  []{#_Toc1034735046 .anchor}**访问控制功能**

> 当前交易系统根据用户访问类型，将用户划分为：交易席位（全席、本席、他席）、行情席位（基本行情席位、深度行情席位）。

1.  > 交易权限控制

> 会员席位等通过交易席位报单时，支持对不同合约设置操作权限，前置根据权限设置，对席位（委托、成交回报、行情席位）的指令，检查是否有权限执行；无权则按"执行失败"处理，并返回席位。
>
> 2\. 服务端权限校验
>
> 席位操作均在服务器端校验用户权限，不依赖客户端传递的权限信息，无篡改风险。

## 存储数据安全

> 交易系统需做好数据留痕，用户通过API或会服系统报入的交易指令（如报单、撤单等），交易系统需通过交易流水持久化或数据库存储方式留痕，保证数据的完整性，确保当日数据可追溯。用户操作记录或管理员操作记录需要保留发送和接收数据的证据（如日志、审计记录），支持事后追溯和合规审计。故在交易系统中需保障敏感个人信息、各类口令、其他重要操作数据在存储过程中的安全性。

1.  []{#_Toc569206381 .anchor}**密钥证书安全存储**

> API模块和交易前置模块中的密钥、数字证书等安全凭证必须加密存储，私钥材料必须使用硬件加密模块或基于国密算法的软件加密进行保护，证书文件在磁盘存储时需进行加密，防止未授权访问和窃取，运行时内存中的临时密钥使用后立即清除。
>
> 在交易系统外建立完善的密钥生成、存储、分发、轮转和销毁机制，根密钥必须使用硬件加密机进行保护，实现密钥的定期轮换，所有对密钥的操作都符合安全合规要求。

2.  []{#_Toc1759481729 .anchor}**数据库落库保护**

> 同步写模块在将数据写入数据库之前，必须对关键字段进行加密处理，敏感业务数据在应用层完成加密后再持久化，加密算法支持可配置，优先采用国密SM4算法，确保数据库存储的敏感信息均为密文形式。其他的敏感信息和各类口令密码必须使用强加密单向哈希算法（如SM3）处理，重要操作数据（如交易记录、审计日志等）需要加密保护。

## 审计范围扩展

> 新一代交易系统在当前基础上继续建立全面、可靠、安全且符合监管要求的审计体系，为系统的安全稳定运行和责任追溯提供坚实支撑。

### **审计范围扩展**​

> 对系统内敏感数据如客户个人信息、关键参数的任何操作，必须强制记录不可更改的审计日志。每条日志应包含操作人、精确时间戳、具体操作内容如修改前值与修改后值、操作结果以及相关业务标识，确保操作行为的可追溯性，用户没有权限控制审计数据的来源。例如，业务操作行为应由应用系统明确定义并记录，操作人身份应根据当前安全会话自动获取，防止用户篡改审计信息。
>
> 审计范围应覆盖交易系统的出入口模块，如前置、交易网关、同步写模块，这些模块涉及到敏感操作时，均需要纳入审计范围。

### **审计功能细化​**

> 审计事件全面覆盖以下三种场景：
>
> 1.用户行为：记录所有用户的成功与失败登录、退出事件。
>
> 2.业务操作：审计所有所内外用户的业务操作请求和结果应答回报，如用户冻结、权限调整。
>
> 3.参数变更：记录通过交易控制台、交易管理系统等外围系统发起的所有系统参数或业务参数的修改操作，如流控参数修改等。
>
> 审计记录的字段要包含部门、程序版本、用户ID、席位IP、具体操作、操作原始数据、操作结果、错误信息、起止日期和时间、附加信息等。
>
> 审计结果可以在业务管理系统使用查询和筛选接口进行检索，审计记录的保存时间、管理员的审计操作方式应与现有系统规范保持一致。

### **审计数据安全​**

> 审计内容应支持数据溯源，但严禁在日志中存储用户口令、口令哈希值等敏感信息。对于日志中必须存储的敏感信息，需进行脱敏处理或严格的访问权限控制，防止业务敏感数据通过日志泄露。应用系统不提供审计记录的删除或修改功能。

# 第六章 开发优化需求描述

# **业务功能**需求列表

------ ---------- ------------------ --------------------------------------------------------------------------------------------------------------------
  序号   模块       业务功能           功能描述

  1      交易系统   数据类型调整       全面弃用浮点数，统一采用整数缩放或字符串方式来表示和处理所有价格与金额字段

  2      交易系统   网络连接管理优化   CA会话请求、CA认证请求、CA授权码认证请求、查询业务提示请求、盘后最优行情请求等五项内容修改为数据传输完毕后断开连接

  3      交易系统   配置文件升级       通过将配置格式由 ini 升级为 yaml，并统一引入标准化的 yaml 解析库

  4      交易系统   时间戳精度优化     提高系统时钟的时间戳精度到微秒
------ ---------- ------------------ --------------------------------------------------------------------------------------------------------------------

# **业务功能需求描述**

\[概括性描述\]

\[按业务类别详细描述业务功能需求, 根据项目涉及业务范围进行裁剪\]

## 数据类型调整

在金融系统中，尤其是需要高精度与绝对确定性的期货交易系统，将价格或任何与金钱相关的字段（如金额、费用、保证金等）设计为 double 或 float 类型，是业界明确禁止的严重设计缺陷。其根本问题在于：双精度浮点数遵循 IEEE 754 二进制表示方式，无法精确表示绝大部分十进制小数，如 0.1、0.01 等都会被表示成近似值。这种先天的精度误差会在关键业务流程中不断累积，从而导致结算价不一致、盈亏偏差、风控判断错误等极高风险后果，更严重的是，不同 CPU 架构、编译器优化级别甚至不同运行时环境中，浮点结果可能出现差异，造成系统在同样输入下无法保证完全相同的输出，这是交易撮合系统绝对不能接受的。

因此，行业共识与最佳实践都明确要求：禁止使用浮点数表达价格与金额。目前有两种公认可靠且安全的方案。

第一种方案是使用整数类型进行存储与计算。这是业内最常用、性能最高、可靠性最强的做法。其核心思想是：根据业务所需的最小价格精度预先确定一个固定的缩放因子（scale），将所有价格与金额统一乘以该因子并转换为整数来保存。例如，如果最小变动单位是 0.01，则将价格乘以 100；如果要支持到小数点后四位，则乘以 10000。这样，像 3500.50 会存成 350050，123.4567 会存成 1234567。整数运算没有任何精度损失，执行速度又是计算机中最快的操作，且完全具备确定性，非常适合撮合引擎和高性能交易核心。需要注意的是，系统文档必须明确说明缩放因子，而在 UI、报表、对外接口等系统边缘，应进行整数与可读格式之间的相互转换。

第二种方案适用于对外 API 层，例如 REST 接口，即使用字符串表示价格。服务器以字符串形式接收诸如 "123.45" 这样的价格值，能够保证十进制表示完全无损，也杜绝了浮点转换导致的误差，且对语言无依赖，任何客户端都能正确处理这种格式。其缺点是性能相对略低，需要服务器端额外进行格式校验与转换，将字符串解析为内部使用的整数或高精度 decimal 类型。但在 API 层，这种开销完全可控，而字符串在接口语义上也最为清晰明确。

综上所述：在核心交易逻辑、撮合、风险控制、清算等任何涉及重要运算的内部模块中，价格必须使用整数（结合固定缩放因子）或等价的精确十进制类型，绝不能使用 double 或 float；在对外数据交互层，可以使用字符串传递十进制价格以确保无损表达和跨语言兼容性。这是金融软件行业的标准实践，也是确保系统精度、安全性与确定性的重要基础。

## 配置文件升级

> 目前配置文件使用ini格式，在结构化和数据类型支持上存在天然缺陷。随着业务发展，配置项日益复杂，ini文件可读性差、难以表达层次化数据的缺点增加了管理难度，容易出错。该非功能需求旨在通过使用yaml格式替换ini格式，并在第三方库中配备统一的yaml读取和访问库，以提升配置文件可读性、规避特殊字符风险和降低管理难度。

### 配置文件升级方案

1.  配置文件的格式化迁移

> 所有现有ini配置文件需按照预设的模板规范，转换为yaml格式。模板将规定统一的顶层结构（如app、server、datasource、logging等章节），确保各服务配置风格一致。
>
> 迁移工作可通过半自动工具辅助完成，但需人工审核转换后的yaml文件，确保结构正确、语义无误。

2.  > 提供统一的yaml配置管理库

> 开发并发布一个公司内部的三方库（如config-yaml），封装yaml文件的读取、解析、环境隔离和类型安全访问等核心功能。
>
> 三方库提供强类型的配置获取方法，如 getString(\"app.name\")、getInt(\"server.port\")、getBoolean(\"feature.enabled\")、getList(\"endpoints\") 等，彻底消除手动类型转换的繁琐与风险。通过此库，各服务可删除原有重复的ini解析代码，实现配置访问方式的统一，降低后续的配置管理难度和维护成本。

## 网络连接管理优化

> 目前交易网关共涉及 11 类主要数据流，包括：市场状态变更通知、席位密码更新、席位密码重置、行情密码更新、CA 会话请求、CA 认证请求、CA 授权码认证请求、审计信息写入、CA 会话与审计、查询业务提示请求以及盘后最优行情请求。
>
> 其中，市场状态变更通知等消息在前置发送前会主动申请建立 TCP 连接，并在发送完成后立即主动断开；但 CA 会话请求、CA 认证请求、CA 授权码认证请求、查询业务提示请求和盘后最优行情请求这五类消息在完成数据发送后并未主动关闭连接，导致连接长时间保持，触发防火墙空闲超时处理。
>
> 为统一连接管理策略，计划将上述五类消息的网络连接处理时机调整为与其他消息一致：在使用前主动建立 TCP 连接，在消息发送完成后主动断开连接。

## 时间戳精度优化

> 提高系统时钟的时间戳精度到微秒。当前生产上，时间戳的产生以及使用流程如下图所示：

> ![sequence](media/image8.png){width="5.304166666666666in" height="3.675in"}

> CReactor通过循环调用SyncTime()不断产生时间戳。在总线转发一个CFTSPPackage对象的时候，会先调用CReactor的CurTime()获取单位为毫秒的时间戳，然后调用自身的SetTimeMark方法，将时间戳填充到成员TFTSPHeader的TimeMark成员中。当应用设备接收到CFTSPPackage对象之后，CCommandDispatcher通过调用CFTSPPackage的GetTimeMark方法获取它所携带的时间戳，并将该时间戳保存在自身的成员变量m_uTimeMark中。

> 当前生产上与时间戳有关的类图如下：

> ![类图1](media/image9.png){width="5.756944444444445in" height="0.8340277777777778in"}

> 上述类图中，CCommandDispatcher的m_uTimeMark成员用于保存来自CFTSPPackage对象的时间戳之外，还提供GetTimeStr和GetMsecTimeStr两个方法。它们的功能分别是通过m_uTimeMark时间戳去换算成当日以秒为单位和以毫秒为单位的格式化的时间字符串，以供业务逻辑使用。CCommdHandle的GetTimeInt方法则是CFTSPPackage的GetTimeMark方法的简单封装，返回四字节无符号整型的时间戳。

> 下图为添加了与微秒时间戳相关的接口的类图：

> ![类图2](media/image10.png){width="5.7659722222222225in" height="1.163888888888889in"}

> 如上图所示，CFTSPPackage的成员TFTSPHeader中将添加一个类型为8字节无符号整型的成员MicroSecTimeMark,用于保存单位为微秒的时间戳。新增加的SetMicroSecTimeMark的功能与SetTimeMark的功能类似，但是SetMicroSecTimeMark用于将来自CReactor的微秒为单位的时间戳保存在TFTSPHeader的MicroSecTimeMark成员中。GetMicroSecTimeMark为获取MicroSecTimeMark成员的接口。CCommandDispatcher中也添加相应的无符号长整型成员m_uMicroSecTimeMark用于保存来自CFTSPPackage的微秒级时间戳。CCommandDispatcher的GetMicroSecTimeStr方法通过将m_uMicroSecTimeMark中保存的以微秒为单位的时间戳转换成格式化的字符串格式供上层业务使用，具体的封装逻辑可由上层业务灵活适配修改。同理，CCommandHandle的GetMicroSecTimeInt方法是对CFTSPPackage的GetMicroSecTimeMark方法的简单封装，返回8字节无符号整型的时间戳，也可由上层业务灵活修改适配。
